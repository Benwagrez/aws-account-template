AWSTemplateFormatVersion: 2010-09-09
Description: AWS CloudFormation Organizations Deployment
Parameters:
  TerraformSPNNameInput:
    Type: String
    AllowedPattern: ^[a-zA-Z0-9_\-]*$
    MaxLength: 30
    Default: TerraformSPN
    Description: Input the name of the IAM account provisioned for use with Terraform for the AWS Organizations deployment.
  StateBucketNameInput:
    Type: String
    AllowedPattern: ^[a-z0-9.\-]*$
    MaxLength: 40
    Default: terraform-state
    Description: Input the name of the S3 bucket which will hold the Terraform state file configuration for your AWS organizations deployment.
Resources:
  TerraformSPN:
    Type: AWS::IAM::User
    Properties:
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AdministratorAccess
      Tags:
        - Key: ApplicationId
          Value: FOUNDATIONAL
        - Key: BusinessUnitId
          Value: Cloud Operations
        - Key: CostCenter
          Value: 000001
        - Key: EnvironmentId
          Value: Production
        - Key: Description
          Value: Terraform SPN for the root AWS account
      UserName: !Sub '${TerraformSPNNameInput}-${AWS::Region}-${AWS::AccountId}'
  TerraformSPNAccessKey:
    Type: AWS::IAM::AccessKey
    Properties:
      Status: Active
      UserName:
        Ref: TerraformSPN
    DependsOn: TerraformSPN
  TerraformSPNAccessKeyStore:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Join ["", [/terraform/credentials/accesskey/,!Ref TerraformSPN]]
      SecretString: !Ref TerraformSPNAccessKey
    DependsOn: TerraformSPN
  TerraformSPNSecretAccessKeyStore:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Join ["", [/terraform/credentials/secretaccesskey/,!Ref TerraformSPN]]
      SecretString: !GetAtt TerraformSPNAccessKey.SecretAccessKey
    DependsOn: TerraformSPN
  RemoteStateS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${StateBucketNameInput}-${AWS::Region}-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - BucketKeyEnabled: true
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: ApplicationId
          Value: FOUNDATIONAL
        - Key: BusinessUnitId
          Value: Cloud Operations
        - Key: CostCenter
          Value: '000001'
        - Key: EnvironmentId
          Value: Production
        - Key: Description
          Value: Terraform remote state management for the root AWS account
  RemoteStateS3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref RemoteStateS3Bucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
              - 's3:*'
            Effect: Allow
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !Ref RemoteStateS3Bucket
                - '/*, arn:aws:s3:::'
                - !Ref RemoteStateS3Bucket
            Principal: '*'
          - Action:
              - 's3:PutObject'
              - 's3:DeleteObject'
            Effect: Deny
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !Ref RemoteStateS3Bucket
                - /*
            Principal: '*'
            Condition:
              StringNotEquals:
                'aws:username':
                  - !Ref TerraformSPN
  RemoteStateDynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      KeySchema:
        - AttributeName: LockID
          KeyType: HASH
      TableName: !Sub '${StateBucketNameInput}-backendlocking-${AWS::Region}-${AWS::AccountId}'
      AttributeDefinitions:
        - AttributeName: LockID
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      Tags:
        - Key: ApplicationId
          Value: FOUNDATIONAL
        - Key: BusinessUnitId
          Value: Cloud Operations
        - Key: CostCenter
          Value: 000001
        - Key: EnvironmentId
          Value: Production
        - Key: Description
          Value: Terraform remote state management for the root AWS account
Outputs:
  TerraformSPNAccessKeyStoreURLOutput:
    Description: Location of the access key credentials for the TerraformSPN
    Value:
      Ref: TerraformSPNAccessKeyStore
  RemoteStateBucketNameOutput:
    Description: Name of the S3 bucket that stores Terraform state
    Value:
      Ref: RemoteStateS3Bucket
  RemoteStateRegionOutput:
    Description: Region of the S3 bucket that stores Terraform state
    Value: !Sub ${AWS::Region}
  RemoteStateDynamoDBNameOutput:
    Description: Name of the DynamoDB table that locks state
    Value:
      Ref: RemoteStateDynamoDBTable
